
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeCanvas - Ultimate Ideation Studio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-hover: #30363d;
            --border-primary: #30363d;
            --border-secondary: #21262d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --text-tertiary: #58a6ff;
            --accent-primary: #58a6ff;
            --accent-secondary: #1f6feb;
            --accent-success: #3fb950;
            --accent-warning: #d29922;
            --accent-danger: #f85149;
            --shadow-sm: 0 1px 0 rgba(27,31,35,0.04);
            --shadow-md: 0 3px 6px rgba(0,0,0,0.3);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            user-select: none;
        }

        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Toolbar */
        .toolbar {
            width: 60px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            padding: 10px 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .tool-btn {
            width: 44px;
            height: 44px;
            margin: 4px auto;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
        }

        .tool-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .tool-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-secondary);
            box-shadow: 0 0 12px rgba(88, 166, 255, 0.4);
        }

        .tool-btn svg {
            width: 20px;
            height: 20px;
        }

        .tooltip {
            position: absolute;
            left: 100%;
            margin-left: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }

        .tool-btn:hover .tooltip {
            opacity: 1;
        }

        .toolbar-divider {
            height: 1px;
            background: var(--border-primary);
            margin: 8px 10px;
        }

        /* Properties Panel */
        .properties-panel {
            width: 280px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-primary);
            padding: 20px;
            overflow-y: auto;
            z-index: 100;
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .properties-panel.hidden {
            transform: translateX(100%);
        }

        .property-group {
            margin-bottom: 20px;
        }

        .property-label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .property-input {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .property-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .property-input[type="range"] {
            padding: 4px 0;
        }

        .color-picker-wrapper {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .color-swatch:hover {
            transform: scale(1.1);
            border-color: var(--text-primary);
        }

        .color-swatch.active {
            border-color: var(--accent-primary);
            box-shadow: 0 0 8px rgba(88, 166, 255, 0.4);
        }

        /* Canvas Area */
        .canvas-container {
            flex: 1;
            position: relative;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .canvas {
            position: absolute;
            width: 5000px;
            height: 5000px;
            background-image: 
                linear-gradient(var(--border-secondary) 1px, transparent 1px),
                linear-gradient(90deg, var(--border-secondary) 1px, transparent 1px);
            background-size: 20px 20px;
            transform-origin: center center;
        }

        .canvas.no-grid {
            background-image: none;
        }

        /* Top Bar */
        .top-bar {
            position: absolute;
            top: 0;
            left: 60px;
            right: 280px;
            height: 50px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 99;
            box-shadow: var(--shadow-sm);
        }

        .project-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .project-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .project-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 6px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: var(--bg-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: var(--accent-primary);
            border-color: var(--accent-secondary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-secondary);
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 300px;
            display: flex;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .zoom-btn:hover {
            background: var(--bg-hover);
        }

        .zoom-level {
            min-width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Canvas Elements */
        .canvas-element {
            position: absolute;
            cursor: move;
        }

        .canvas-element.selected {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        .text-element {
            padding: 10px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: inherit;
            resize: none;
            outline: none;
            min-width: 100px;
            min-height: 30px;
        }

        .code-element {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            white-space: pre;
            overflow: auto;
            min-width: 200px;
            min-height: 100px;
        }

        .shape-element {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .project-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            background: var(--bg-tertiary);
        }

        .project-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-primary);
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-item:hover {
            background: var(--bg-hover);
        }

        .project-item:last-child {
            border-bottom: none;
        }

        .project-date {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 20px;
            left: 80px;
            width: 56px;
            height: 56px;
            background: var(--accent-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            background: var(--accent-secondary);
            box-shadow: 0 0 20px rgba(88, 166, 255, 0.6);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Toolbar -->
        <div class="toolbar">
            <button class="tool-btn active" data-tool="select">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/>
                </svg>
                <span class="tooltip">Select Tool (V)</span>
            </button>
            <button class="tool-btn" data-tool="brush">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                </svg>
                <span class="tooltip">Brush Tool (B)</span>
            </button>
            <button class="tool-btn" data-tool="eraser">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 21H9l-7-7a2 2 0 010-2.83l10-10a2 2 0 012.83 0l7 7a2 2 0 010 2.83L13 21"/>
                </svg>
                <span class="tooltip">Eraser Tool (E)</span>
            </button>
            <button class="tool-btn" data-tool="text">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M13 4h-2v16h2M6 20h12M6 4h12"/>
                </svg>
                <span class="tooltip">Text Tool (T)</span>
            </button>
            <button class="tool-btn" data-tool="shape">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                </svg>
                <span class="tooltip">Shape Tool (S)</span>
            </button>
            <button class="tool-btn" data-tool="connector">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 11L3 17l6 6 6-6-6-6zM21 3l-6 6 6 6"/>
                </svg>
                <span class="tooltip">Connector Tool (C)</span>
            </button>
            <button class="tool-btn" data-tool="code">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="16 18 22 12 16 6"/>
                    <polyline points="8 6 2 12 8 18"/>
                </svg>
                <span class="tooltip">Code Snippet</span>
            </button>
            <div class="toolbar-divider"></div>
            <button class="tool-btn" id="undoBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 7v6h6"/>
                    <path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"/>
                </svg>
                <span class="tooltip">Undo (Ctrl+Z)</span>
            </button>
            <button class="tool-btn" id="redoBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 7v6h-6"/>
                    <path d="M3 17a9 9 0 019-9 9 9 0 016 2.3L21 13"/>
                </svg>
                <span class="tooltip">Redo (Ctrl+Y)</span>
            </button>
            <button class="tool-btn" id="gridToggle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="6" height="6"/>
                    <rect x="15" y="3" width="6" height="6"/>
                    <rect x="3" y="15" width="6" height="6"/>
                    <rect x="15" y="15" width="6" height="6"/>
                </svg>
                <span class="tooltip">Toggle Grid</span>
            </button>
        </div>

        <!-- Canvas Container -->
        <div class="canvas-container">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="project-info">
                    <span class="project-name" id="projectName">Untitled Project</span>
                </div>
                <div class="project-actions">
                    <button class="btn" id="newProjectBtn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        New
                    </button>
                    <button class="btn" id="openProjectBtn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/>
                        </svg>
                        Open
                    </button>
                    <button class="btn" id="saveProjectBtn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                            <polyline points="17 21 17 13 7 13 7 21"/>
                            <polyline points="7 3 7 8 15 8"/>
                        </svg>
                        Save
                    </button>
                    <button class="btn btn-primary" id="exportBtn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Export
                    </button>
                    <button class="btn" id="importBtn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Import
                    </button>
                </div>
            </div>

            <!-- Canvas -->
            <div class="canvas" id="canvas"></div>

            <!-- Zoom Controls -->
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomOut">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                </button>
                <div class="zoom-level" id="zoomLevel">100%</div>
                <button class="zoom-btn" id="zoomIn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                </button>
                <button class="zoom-btn" id="zoomReset">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Properties Panel -->
        <div class="properties-panel" id="propertiesPanel">
            <h3 style="margin-bottom: 20px; font-size: 16px; font-weight: 600;">Properties</h3>
            
            <!-- Brush Properties -->
            <div id="brushProperties" style="display: none;">
                <div class="property-group">
                    <label class="property-label">Brush Color</label>
                    <div class="color-picker-wrapper">
                        <div class="color-swatch active" style="background: #ffffff;" data-color="#ffffff"></div>
                        <div class="color-swatch" style="background: #f85149;" data-color="#f85149"></div>
                        <div class="color-swatch" style="background: #3fb950;" data-color="#3fb950"></div>
                        <div class="color-swatch" style="background: #58a6ff;" data-color="#58a6ff"></div>
                        <div class="color-swatch" style="background: #d29922;" data-color="#d29922"></div>
                        <div class="color-swatch" style="background: #a371f7;" data-color="#a371f7"></div>
                        <div class="color-swatch" style="background: #ff7b72;" data-color="#ff7b72"></div>
                        <div class="color-swatch" style="background: #79c0ff;" data-color="#79c0ff"></div>
                    </div>
                </div>
                <div class="property-group">
                    <label class="property-label">Brush Size</label>
                    <input type="range" class="property-input" id="brushSize" min="1" max="20" value="3">
                    <div style="text-align: center; margin-top: 5px; font-size: 12px; color: var(--text-secondary);">
                        <span id="brushSizeValue">3</span>px
                    </div>
                </div>
                <div class="property-group">
                    <label class="property-label">Opacity</label>
                    <input type="range" class="property-input" id="brushOpacity" min="0" max="100" value="100">
                    <div style="text-align: center; margin-top: 5px; font-size: 12px; color: var(--text-secondary);">
                        <span id="brushOpacityValue">100</span>%
                    </div>
                </div>
            </div>

            <!-- Text Properties -->
            <div id="textProperties" style="display: none;">
                <div class="property-group">
                    <label class="property-label">Font Family</label>
                    <select class="property-input" id="fontFamily">
                        <option value="Arial">Arial</option>
                        <option value="Helvetica">Helvetica</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Comic Sans MS">Comic Sans MS</option>
                    </select>
                </div>
                <div class="property-group">
                    <label class="property-label">Font Size</label>
                    <input type="number" class="property-input" id="fontSize" value="16" min="8" max="72">
                </div>
                <div class="property-group">
                    <label class="property-label">Text Color</label>
                    <input type="color" class="property-input" id="textColor" value="#c9d1d9">
                </div>
                <div class="property-group">
                    <label class="property-label">Formatting</label>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" id="boldBtn" style="flex: 1; font-weight: bold;">B</button>
                        <button class="btn" id="italicBtn" style="flex: 1; font-style: italic;">I</button>
                        <button class="btn" id="underlineBtn" style="flex: 1; text-decoration: underline;">U</button>
                    </div>
                </div>
            </div>

            <!-- Shape Properties -->
            <div id="shapeProperties" style="display: none;">
                <div class="property-group">
                    <label class="property-label">Shape Type</label>
                    <select class="property-input" id="shapeType">
                        <option value="rectangle">Rectangle</option>
                        <option value="circle">Circle</option>
                        <option value="triangle">Triangle</option>
                        <option value="diamond">Diamond</option>
                        <option value="arrow">Arrow</option>
                        <option value="cloud">Cloud</option>
                        <option value="sticky">Sticky Note</option>
                    </select>
                </div>
                <div class="property-group">
                    <label class="property-label">Fill Color</label>
                    <input type="color" class="property-input" id="shapeFillColor" value="#58a6ff">
                </div>
                <div class="property-group">
                    <label class="property-label">Stroke Color</label>
                    <input type="color" class="property-input" id="shapeStrokeColor" value="#ffffff">
                </div>
                <div class="property-group">
                    <label class="property-label">Stroke Width</label>
                    <input type="range" class="property-input" id="shapeStrokeWidth" min="0" max="10" value="2">
                </div>
            </div>

            <!-- Code Properties -->
            <div id="codeProperties" style="display: none;">
                <div class="property-group">
                    <label class="property-label">Language</label>
                    <select class="property-input" id="codeLanguage">
                        <option value="javascript">JavaScript</option>
                        <option value="python">Python</option>
                        <option value="html">HTML</option>
                        <option value="css">CSS</option>
                        <option value="java">Java</option>
                        <option value="cpp">C++</option>
                        <option value="typescript">TypeScript</option>
                        <option value="rust">Rust</option>
                        <option value="go">Go</option>
                        <option value="ruby">Ruby</option>
                        <option value="php">PHP</option>
                        <option value="swift">Swift</option>
                    </select>
                </div>
                <div class="property-group">
                    <label class="property-label">Theme</label>
                    <select class="property-input" id="codeTheme">
                        <option value="dark">Dark</option>
                        <option value="light">Light</option>
                        <option value="monokai">Monokai</option>
                    </select>
                </div>
            </div>

            <!-- General Element Properties -->
            <div id="elementProperties" style="display: none;">
                <div class="property-group">
                    <label class="property-label">Layer Order</label>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" id="bringToFrontBtn" style="flex: 1;">Bring to Front</button>
                        <button class="btn" id="sendToBackBtn" style="flex: 1;">Send to Back</button>
                    </div>
                </div>
                <div class="property-group">
                    <button class="btn" id="deleteElementBtn" style="width: 100%; background: var(--accent-danger);">
                        Delete Element
                    </button>
                </div>
            </div>
        </div>

        <!-- Floating Action Button -->
        <div class="fab" id="fabMenu">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        </div>
    </div>

    <!-- Project Manager Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <h2 class="modal-header">Project Manager</h2>
            <div class="modal-body">
                <div class="project-list" id="projectList"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="loadProjectBtn">Load Project</button>
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div class="modal" id="newProjectModal">
        <div class="modal-content">
            <h2 class="modal-header">Create New Project</h2>
            <div class="modal-body">
                <div class="property-group">
                    <label class="property-label">Project Name</label>
                    <input type="text" class="property-input" id="newProjectName" placeholder="Enter project name...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="createProjectBtn">Create</button>
            </div>
        </div>
    </div>

    <script>
        // Global State
        const state = {
            currentTool: 'select',
            currentProject: null,
            projects: {},
            canvas: {
                zoom: 1,
                panX: 0,
                panY: 0,
                elements: [],
                selectedElement: null
            },
            history: {
                undoStack: [],
                redoStack: []
            },
            brushSettings: {
                color: '#ffffff',
                size: 3,
                opacity: 1
            },
            textSettings: {
                fontFamily: 'Arial',
                fontSize: 16,
                color: '#c9d1d9',
                bold: false,
                italic: false,
                underline: false
            },
            shapeSettings: {
                type: 'rectangle',
                fillColor: '#58a6ff',
                strokeColor: '#ffffff',
                strokeWidth: 2
            },
            codeSettings: {
                language: 'javascript',
                theme: 'dark'
            },
            isDrawing: false,
            isPanning: false,
            startPoint: null,
            currentPath: null
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            loadProjects();
            setupEventListeners();
            setupKeyboardShortcuts();
            startAutosave();
        });

        function initializeApp() {
            // Set initial canvas position
            const canvas = document.getElementById('canvas');
            const container = document.querySelector('.canvas-container');
            
            // Center the canvas
            state.canvas.panX = (container.clientWidth - 5000) / 2;
            state.canvas.panY = (container.clientHeight - 5000) / 2;
            
            updateCanvasTransform();
            
            // Create default project if none exists
            if (Object.keys(state.projects).length === 0) {
                createNewProject('Untitled Project');
            }
        }

        function setupEventListeners() {
            // Tool buttons
            document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectTool(btn.dataset.tool);
                });
            });

            // Canvas interactions
            const canvas = document.getElementById('canvas');
            canvas.addEventListener('mousedown', handleCanvasMouseDown);
            canvas.addEventListener('mousemove', handleCanvasMouseMove);
            canvas.addEventListener('mouseup', handleCanvasMouseUp);
            canvas.addEventListener('wheel', handleCanvasWheel);
            
            // Touch support
            canvas.addEventListener('touchstart', handleCanvasTouchStart);
            canvas.addEventListener('touchmove', handleCanvasTouchMove);
            canvas.addEventListener('touchend', handleCanvasTouchEnd);

            // Zoom controls
            document.getElementById('zoomIn').addEventListener('click', () => zoom(1.2));
            document.getElementById('zoomOut').addEventListener('click', () => zoom(0.8));
            document.getElementById('zoomReset').addEventListener('click', () => resetZoom());

            // Project actions
            document.getElementById('newProjectBtn').addEventListener('click', showNewProjectModal);
            document.getElementById('openProjectBtn').addEventListener('click', showProjectModal);
            document.getElementById('saveProjectBtn').addEventListener('click', saveCurrentProject);
            document.getElementById('exportBtn').addEventListener('click', exportProject);
            document.getElementById('importBtn').addEventListener('click', importProject);

            // Grid toggle
            document.getElementById('gridToggle').addEventListener('click', toggleGrid);

            // Undo/Redo
            document.getElementById('undoBtn').addEventListener('click', undo);
            document.getElementById('redoBtn').addEventListener('click', redo);

            // Properties panel
            setupPropertyListeners();

            // FAB menu
            document.getElementById('fabMenu').addEventListener('click', showQuickActions);

            // Modal actions
            document.getElementById('createProjectBtn').addEventListener('click', handleCreateProject);
            document.getElementById('loadProjectBtn').addEventListener('click', handleLoadProject);
        }

        function setupPropertyListeners() {
            // Brush properties
            const brushSize = document.getElementById('brushSize');
            brushSize.addEventListener('input', (e) => {
                state.brushSettings.size = parseInt(e.target.value);
                document.getElementById('brushSizeValue').textContent = e.target.value;
            });

            const brushOpacity = document.getElementById('brushOpacity');
            brushOpacity.addEventListener('input', (e) => {
                state.brushSettings.opacity = parseInt(e.target.value) / 100;
                document.getElementById('brushOpacityValue').textContent = e.target.value;
            });

            // Color swatches
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.addEventListener('click', () => {
                    document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
                    swatch.classList.add('active');
                    state.brushSettings.color = swatch.dataset.color;
                });
            });

            // Text properties
            document.getElementById('fontFamily').addEventListener('change', (e) => {
                state.textSettings.fontFamily = e.target.value;
                updateSelectedTextElement();
            });

            document.getElementById('fontSize').addEventListener('input', (e) => {
                state.textSettings.fontSize = parseInt(e.target.value);
                updateSelectedTextElement();
            });

            document.getElementById('textColor').addEventListener('input', (e) => {
                state.textSettings.color = e.target.value;
                updateSelectedTextElement();
            });

            // Shape properties
            document.getElementById('shapeType').addEventListener('change', (e) => {
                state.shapeSettings.type = e.target.value;
            });

            document.getElementById('shapeFillColor').addEventListener('input', (e) => {
                state.shapeSettings.fillColor = e.target.value;
                updateSelectedShapeElement();
            });

            document.getElementById('shapeStrokeColor').addEventListener('input', (e) => {
                state.shapeSettings.strokeColor = e.target.value;
                updateSelectedShapeElement();
            });

            document.getElementById('shapeStrokeWidth').addEventListener('input', (e) => {
                state.shapeSettings.strokeWidth = parseInt(e.target.value);
                updateSelectedShapeElement();
            });

            // Code properties
            document.getElementById('codeLanguage').addEventListener('change', (e) => {
                state.codeSettings.language = e.target.value;
            });

            document.getElementById('codeTheme').addEventListener('change', (e) => {
                state.codeSettings.theme = e.target.value;
            });

            // Element actions
            document.getElementById('deleteElementBtn')?.addEventListener('click', deleteSelectedElement);
            document.getElementById('bringToFrontBtn')?.addEventListener('click', () => changeElementOrder('front'));
            document.getElementById('sendToBackBtn')?.addEventListener('click', () => changeElementOrder('back'));
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Tool shortcuts
                if (!e.ctrlKey && !e.metaKey) {
                    switch(e.key.toLowerCase()) {
                        case 'v': selectTool('select'); break;
                        case 'b': selectTool('brush'); break;
                        case 'e': selectTool('eraser'); break;
                        case 't': selectTool('text'); break;
                        case 's': selectTool('shape'); break;
                        case 'c': selectTool('connector'); break;
                    }
                }

                // Undo/Redo
                if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    undo();
                }
                if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                    e.preventDefault();
                    redo();
                }

                // Delete
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    if (state.canvas.selectedElement && !e.target.classList.contains('text-element')) {
                        e.preventDefault();
                        deleteSelectedElement();
                    }
                }

                // Save
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveCurrentProject();
                }
            });
        }

        function selectTool(tool) {
            state.currentTool = tool;
            
            // Update UI
            document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
            
            // Update properties panel
            updatePropertiesPanel(tool);
            
            // Update cursor
            const canvas = document.getElementById('canvas');
            switch(tool) {
                case 'select':
                    canvas.style.cursor = 'default';
                    break;
                case 'brush':
                case 'eraser':
                    canvas.style.cursor = 'crosshair';
                    break;
                case 'text':
                    canvas.style.cursor = 'text';
                    break;
                case 'shape':
                case 'connector':
                case 'code':
                    canvas.style.cursor = 'crosshair';
                    break;
            }
        }

        function updatePropertiesPanel(tool) {
            // Hide all property panels
            document.getElementById('brushProperties').style.display = 'none';
            document.getElementById('textProperties').style.display = 'none';
            document.getElementById('shapeProperties').style.display = 'none';
            document.getElementById('codeProperties').style.display = 'none';
            document.getElementById('elementProperties').style.display = 'none';
            
            // Show relevant panel
            switch(tool) {
                case 'brush':
                case 'eraser':
                    document.getElementById('brushProperties').style.display = 'block';
                    break;
                case 'text':
                    document.getElementById('textProperties').style.display = 'block';
                    break;
                case 'shape':
                    document.getElementById('shapeProperties').style.display = 'block';
                    break;
                case 'code':
                    document.getElementById('codeProperties').style.display = 'block';
                    break;
            }
            
            // Show element properties if something is selected
            if (state.canvas.selectedElement) {
                document.getElementById('elementProperties').style.display = 'block';
            }
        }

        function handleCanvasMouseDown(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const x = (e.clientX - rect.left) / state.canvas.zoom - state.canvas.panX;
            const y = (e.clientY - rect.top) / state.canvas.zoom - state.canvas.panY;
            
            state.startPoint = { x, y };
            
            switch(state.currentTool) {
                case 'select':
                    handleSelectStart(x, y, e);
                    break;
                case 'brush':
                    startDrawing(x, y);
                    break;
                case 'eraser':
                    startErasing(x, y);
                    break;
                case 'text':
                    createTextElement(x, y);
                    break;
                case 'shape':
                    createShapeElement(x, y);
                    break;
                case 'code':
                    createCodeElement(x, y);
                    break;
            }
            
            // Middle mouse button for panning
            if (e.button === 1) {
                state.isPanning = true;
                e.currentTarget.style.cursor = 'grabbing';
            }
        }

        function handleCanvasMouseMove(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const x = (e.clientX - rect.left) / state.canvas.zoom - state.canvas.panX;
            const y = (e.clientY - rect.top) / state.canvas.zoom - state.canvas.panY;
            
            if (state.isPanning && state.startPoint) {
                const dx = x - state.startPoint.x;
                const dy = y - state.startPoint.y;
                state.canvas.panX += dx;
                state.canvas.panY += dy;
                updateCanvasTransform();
                return;
            }
            
            if (state.isDrawing && state.currentPath) {
                if (state.currentTool === 'brush') {
                    drawLine(state.startPoint.x, state.startPoint.y, x, y);
                } else if (state.currentTool === 'eraser') {
                    eraseLine(state.startPoint.x, state.startPoint.y, x, y);
                }
                state.startPoint = { x, y };
            }
        }

        function handleCanvasMouseUp(e) {
            if (state.isDrawing) {
                state.isDrawing = false;
                if (state.currentPath) {
                    saveToHistory();
                    state.currentPath = null;
                }
            }
            
            if (state.isPanning) {
                state.isPanning = false;
                e.currentTarget.style.cursor = getCursorForTool(state.currentTool);
            }
            
            state.startPoint = null;
        }

        function handleCanvasWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            zoom(delta, e.clientX, e.clientY);
        }

        function handleCanvasTouchStart(e) {
            const touch = e.touches[0];
            const rect = e.currentTarget.getBoundingClientRect();
            const x = (touch.clientX - rect.left) / state.canvas.zoom - state.canvas.panX;
            const y = (touch.clientY - rect.top) / state.canvas.zoom - state.canvas.panY;
            
            state.startPoint = { x, y };
            
            if (state.currentTool === 'brush') {
                startDrawing(x, y);
            }
        }

        function handleCanvasTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = e.currentTarget.getBoundingClientRect();
            const x = (touch.clientX - rect.left) / state.canvas.zoom - state.canvas.panX;
            const y = (touch.clientY - rect.top) / state.canvas.zoom - state.canvas.panY;
            
            if (state.isDrawing && state.currentPath) {
                drawLine(state.startPoint.x, state.startPoint.y, x, y);
                state.startPoint = { x, y };
            }
        }

        function handleCanvasTouchEnd(e) {
            if (state.isDrawing) {
                state.isDrawing = false;
                if (state.currentPath) {
                    saveToHistory();
                    state.currentPath = null;
                }
            }
            state.startPoint = null;
        }

        function startDrawing(x, y) {
            state.isDrawing = true;
            const svg = createSVGElement();
            state.currentPath = svg;
            state.canvas.elements.push({
                type: 'drawing',
                element: svg,
                id: generateId()
            });
            document.getElementById('canvas').appendChild(svg);
        }

        function drawLine(x1, y1, x2, y2) {
            if (!state.currentPath) return;
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', x1);
            line.setAttribute('y1', y1);
            line.setAttribute('x2', x2);
            line.setAttribute('y2', y2);
            line.setAttribute('stroke', state.brushSettings.color);
            line.setAttribute('stroke-width', state.brushSettings.size);
            line.setAttribute('stroke-opacity', state.brushSettings.opacity);
            line.setAttribute('stroke-linecap', 'round');
            
            state.currentPath.appendChild(line);
        }

        function startErasing(x, y) {
            // Eraser works by drawing with background color
            const originalColor = state.brushSettings.color;
            state.brushSettings.color = '#0d1117'; // Background color
            startDrawing(x, y);
            // Restore original color after erasing
            setTimeout(() => {
                state.brushSettings.color = originalColor;
            }, 0);
        }

        function eraseLine(x1, y1, x2, y2) {
            // Use background color for erasing
            const originalColor = state.brushSettings.color;
            state.brushSettings.color = '#0d1117';
            drawLine(x1, y1, x2, y2);
            state.brushSettings.color = originalColor;
        }

        function createSVGElement() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.style.position = 'absolute';
            svg.style.top = '0';
            svg.style.left = '0';
            svg.style.width = '100%';
            svg.style.height = '100%';
            svg.style.pointerEvents = 'none';
            svg.classList.add('canvas-element');
            return svg;
        }

        function createTextElement(x, y) {
            const textarea = document.createElement('textarea');
            textarea.className = 'text-element canvas-element';
            textarea.style.left = x + 'px';
            textarea.style.top = y + 'px';
            textarea.style.fontFamily = state.textSettings.fontFamily;
            textarea.style.fontSize = state.textSettings.fontSize + 'px';
            textarea.style.color = state.textSettings.color;
            textarea.style.fontWeight = state.textSettings.bold ? 'bold' : 'normal';
            textarea.style.fontStyle = state.textSettings.italic ? 'italic' : 'normal';
            textarea.style.textDecoration = state.textSettings.underline ? 'underline' : 'none';
            textarea.placeholder = 'Type here...';
            
            const element = {
                type: 'text',
                element: textarea,
                id: generateId(),
                x: x,
                y: y
            };
            
            state.canvas.elements.push(element);
            document.getElementById('canvas').appendChild(textarea);
            
            textarea.focus();
            
            textarea.addEventListener('mousedown', (e) => {
                if (state.currentTool === 'select') {
                    selectElement(element);
                    e.stopPropagation();
                }
            });
            
            textarea.addEventListener('input', () => {
                saveToHistory();
            });
            
            selectElement(element);
            saveToHistory();
        }

        function createShapeElement(x, y) {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.style.position = 'absolute';
            svg.style.left = x + 'px';
            svg.style.top = y + 'px';
            svg.style.width = '100px';
            svg.style.height = '100px';
            svg.classList.add('canvas-element', 'shape-element');
            
            let shape;
            switch(state.shapeSettings.type) {
                case 'rectangle':
                    shape = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    shape.setAttribute('width', '100');
                    shape.setAttribute('height', '100');
                    shape.setAttribute('rx', '8');
                    break;
                case 'circle':
                    shape = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    shape.setAttribute('cx', '50');
                    shape.setAttribute('cy', '50');
                    shape.setAttribute('r', '50');
                    break;
                case 'triangle':
                    shape = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                    shape.setAttribute('points', '50,10 90,90 10,90');
                    break;
                case 'diamond':
                    shape = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                    shape.setAttribute('points', '50,10 90,50 50,90 10,50');
                    break;
                case 'arrow':
                    shape = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    shape.setAttribute('d', 'M10,50 L60,50 L60,30 L90,50 L60,70 L60,50');
                    break;
                case 'cloud':
                    shape = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    shape.setAttribute('d', 'M25,60 Q15,60 15,50 Q15,35 30,35 Q30,25 40,25 Q50,25 55,30 Q65,20 75,25 Q85,30 85,40 Q90,45 90,55 Q90,65 80,65 Z');
                    break;
                case 'sticky':
                    shape = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    shape.setAttribute('width', '100');
                    shape.setAttribute('height', '100');
                    shape.setAttribute('rx', '2');
                    state.shapeSettings.fillColor = '#d29922';
                    break;
            }
            
            shape.setAttribute('fill', state.shapeSettings.fillColor);
            shape.setAttribute('stroke', state.shapeSettings.strokeColor);
            shape.setAttribute('stroke-width', state.shapeSettings.strokeWidth);
            
            svg.appendChild(shape);
            
            const element = {
                type: 'shape',
                element: svg,
                id: generateId(),
                x: x,
                y: y,
                shapeType: state.shapeSettings.type
            };
            
            state.canvas.elements.push(element);
            document.getElementById('canvas').appendChild(svg);
            
            svg.addEventListener('mousedown', (e) => {
                if (state.currentTool === 'select') {
                    selectElement(element);
                    startDragging(e, element);
                    e.stopPropagation();
                }
            });
            
            selectElement(element);
            saveToHistory();
        }

        function createCodeElement(x, y) {
            const pre = document.createElement('pre');
            const code = document.createElement('code');
            pre.className = 'code-element canvas-element';
            pre.style.left = x + 'px';
            pre.style.top = y + 'px';
            code.contentEditable = true;
            code.innerHTML = `// ${state.codeSettings.language} code\nfunction example() {\n  console.log("Hello, CodeCanvas!");\n}`;
            
            // Apply theme
            if (state.codeSettings.theme === 'light') {
                pre.style.background = '#ffffff';
                pre.style.color = '#24292e';
            } else if (state.codeSettings.theme === 'monokai') {
                pre.style.background = '#272822';
                pre.style.color = '#f8f8f2';
            }
            
            pre.appendChild(code);
            
            const element = {
                type: 'code',
                element: pre,
                id: generateId(),
                x: x,
                y: y,
                language: state.codeSettings.language
            };
            
            state.canvas.elements.push(element);
            document.getElementById('canvas').appendChild(pre);
            
            pre.addEventListener('mousedown', (e) => {
                if (state.currentTool === 'select') {
                    selectElement(element);
                    e.stopPropagation();
                }
            });
            
            code.addEventListener('input', () => {
                saveToHistory();
            });
            
            selectElement(element);
            saveToHistory();
        }

        function handleSelectStart(x, y, e) {
            // Check if clicking on an element
            const clickedElement = getElementAtPosition(x, y);
            
            if (clickedElement) {
                selectElement(clickedElement);
                startDragging(e, clickedElement);
            } else {
                // Deselect
                deselectAll();
            }
        }

        function getElementAtPosition(x, y) {
            // Iterate through elements in reverse order (top to bottom)
            for (let i = state.canvas.elements.length - 1; i >= 0; i--) {
                const el = state.canvas.elements[i];
                const bounds = el.element.getBoundingClientRect();
                const canvasRect = document.getElementById('canvas').getBoundingClientRect();
                
                const elX = (bounds.left - canvasRect.left) / state.canvas.zoom;
                const elY = (bounds.top - canvasRect.top) / state.canvas.zoom;
                const elWidth = bounds.width / state.canvas.zoom;
                const elHeight = bounds.height / state.canvas.zoom;
                
                if (x >= elX && x <= elX + elWidth && y >= elY && y <= elY + elHeight) {
                    return el;
                }
            }
            return null;
        }

        function selectElement(element) {
            deselectAll();
            element.element.classList.add('selected');
            state.canvas.selectedElement = element;
            updatePropertiesPanel(state.currentTool);
        }

        function deselectAll() {
            document.querySelectorAll('.canvas-element').forEach(el => {
                el.classList.remove('selected');
            });
            state.canvas.selectedElement = null;
            document.getElementById('elementProperties').style.display = 'none';
        }

        function startDragging(e, element) {
            const startX = e.clientX;
            const startY = e.clientY;
            const startLeft = parseInt(element.element.style.left) || 0;
            const startTop = parseInt(element.element.style.top) || 0;
            
            function handleDrag(e) {
                const dx = (e.clientX - startX) / state.canvas.zoom;
                const dy = (e.clientY - startY) / state.canvas.zoom;
                
                element.element.style.left = (startLeft + dx) + 'px';
                element.element.style.top = (startTop + dy) + 'px';
                
                element.x = startLeft + dx;
                element.y = startTop + dy;
            }
            
            function stopDrag() {
                document.removeEventListener('mousemove', handleDrag);
                document.removeEventListener('mouseup', stopDrag);
                saveToHistory();
            }
            
            document.addEventListener('mousemove', handleDrag);
            document.addEventListener('mouseup', stopDrag);
        }

        function deleteSelectedElement() {
            if (!state.canvas.selectedElement) return;
            
            const index = state.canvas.elements.indexOf(state.canvas.selectedElement);
            if (index > -1) {
                state.canvas.selectedElement.element.remove();
                state.canvas.elements.splice(index, 1);
                state.canvas.selectedElement = null;
                document.getElementById('elementProperties').style.display = 'none';
                saveToHistory();
            }
        }

        function changeElementOrder(direction) {
            if (!state.canvas.selectedElement) return;
            
            const element = state.canvas.selectedElement.element;
            
            if (direction === 'front') {
                element.style.zIndex = getMaxZIndex() + 1;
            } else {
                element.style.zIndex = getMinZIndex() - 1;
            }
            
            saveToHistory();
        }

        function getMaxZIndex() {
            let max = 0;
            state.canvas.elements.forEach(el => {
                const z = parseInt(el.element.style.zIndex) || 0;
                if (z > max) max = z;
            });
            return max;
        }

        function getMinZIndex() {
            let min = 0;
            state.canvas.elements.forEach(el => {
                const z = parseInt(el.element.style.zIndex) || 0;
                if (z < min) min = z;
            });
            return min;
        }

        function updateSelectedTextElement() {
            if (!state.canvas.selectedElement || state.canvas.selectedElement.type !== 'text') return;
            
            const el = state.canvas.selectedElement.element;
            el.style.fontFamily = state.textSettings.fontFamily;
            el.style.fontSize = state.textSettings.fontSize + 'px';
            el.style.color = state.textSettings.color;
            
            saveToHistory();
        }

        function updateSelectedShapeElement() {
            if (!state.canvas.selectedElement || state.canvas.selectedElement.type !== 'shape') return;
            
            const shape = state.canvas.selectedElement.element.firstChild;
            shape.setAttribute('fill', state.shapeSettings.fillColor);
            shape.setAttribute('stroke', state.shapeSettings.strokeColor);
            shape.setAttribute('stroke-width', state.shapeSettings.strokeWidth);
            
            saveToHistory();
        }

        function zoom(factor, centerX, centerY) {
            const oldZoom = state.canvas.zoom;
            state.canvas.zoom *= factor;
            state.canvas.zoom = Math.max(0.1, Math.min(5, state.canvas.zoom));
            
            if (centerX && centerY) {
                const rect = document.getElementById('canvas').getBoundingClientRect();
                const x = (centerX - rect.left) / oldZoom;
                const y = (centerY - rect.top) / oldZoom;
                
                state.canvas.panX -= x * (state.canvas.zoom - oldZoom);
                state.canvas.panY -= y * (state.canvas.zoom - oldZoom);
            }
            
            updateCanvasTransform();
            updateZoomDisplay();
        }

        function resetZoom() {
            state.canvas.zoom = 1;
            const container = document.querySelector('.canvas-container');
            state.canvas.panX = (container.clientWidth - 5000) / 2;
            state.canvas.panY = (container.clientHeight - 5000) / 2;
            updateCanvasTransform();
            updateZoomDisplay();
        }

        function updateCanvasTransform() {
            const canvas = document.getElementById('canvas');
            canvas.style.transform = `translate(${state.canvas.panX}px, ${state.canvas.panY}px) scale(${state.canvas.zoom})`;
        }

        function updateZoomDisplay() {
            document.getElementById('zoomLevel').textContent = Math.round(state.canvas.zoom * 100) + '%';
        }

        function toggleGrid() {
            const canvas = document.getElementById('canvas');
            canvas.classList.toggle('no-grid');
        }

        function getCursorForTool(tool) {
            switch(tool) {
                case 'select': return 'default';
                case 'brush':
                case 'eraser': return 'crosshair';
                case 'text': return 'text';
                case 'shape':
                case 'connector':
                case 'code': return 'crosshair';
                default: return 'default';
            }
        }

        function generateId() {
            return 'el_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // History Management
        function saveToHistory() {
            const snapshot = {
                elements: state.canvas.elements.map(el => ({
                    type: el.type,
                    id: el.id,
                    x: el.x,
                    y: el.y,
                    content: el.element.innerHTML || el.element.value || '',
                    style: el.element.getAttribute('style'),
                    attributes: getElementAttributes(el)
                }))
            };
            
            state.history.undoStack.push(JSON.stringify(snapshot));
            state.history.redoStack = [];
            
            if (state.history.undoStack.length > 50) {
                state.history.undoStack.shift();
            }
        }

        function getElementAttributes(element) {
            const attrs = {};
            if (element.type === 'shape') {
                attrs.shapeType = element.shapeType;
            } else if (element.type === 'code') {
                attrs.language = element.language;
            }
            return attrs;
        }

        function undo() {
            if (state.history.undoStack.length === 0) return;
            
            const current = JSON.stringify({
                elements: state.canvas.elements.map(el => ({
                    type: el.type,
                    id: el.id,
                    x: el.x,
                    y: el.y,
                    content: el.element.innerHTML || el.element.value || '',
                    style: el.element.getAttribute('style'),
                    attributes: getElementAttributes(el)
                }))
            });
            
            state.history.redoStack.push(current);
            const snapshot = JSON.parse(state.history.undoStack.pop());
            restoreSnapshot(snapshot);
        }

        function redo() {
            if (state.history.redoStack.length === 0) return;
            
            const snapshot = JSON.parse(state.history.redoStack.pop());
            restoreSnapshot(snapshot);
            saveToHistory();
        }

        function restoreSnapshot(snapshot) {
            // Clear canvas
            state.canvas.elements.forEach(el => el.element.remove());
            state.canvas.elements = [];
            
            // Restore elements
            snapshot.elements.forEach(data => {
                // Recreate element based on type
                // This is simplified - in production, you'd fully restore all properties
                switch(data.type) {
                    case 'text':
                        const textarea = document.createElement('textarea');
                        textarea.className = 'text-element canvas-element';
                        textarea.setAttribute('style', data.style);
                        textarea.value = data.content;
                        document.getElementById('canvas').appendChild(textarea);
                        
                        state.canvas.elements.push({
                            type: 'text',
                            element: textarea,
                            id: data.id,
                            x: data.x,
                            y: data.y
                        });
                        break;
                    // Add cases for other element types...
                }
            });
        }

        // Project Management
        function createNewProject(name) {
            const projectId = 'project_' + Date.now();
            const project = {
                id: projectId,
                name: name || 'Untitled Project',
                created: new Date().toISOString(),
                modified: new Date().toISOString(),
                canvas: {
                    elements: [],
                    zoom: 1,
                    panX: 0,
                    panY: 0
                }
            };
            
            state.projects[projectId] = project;
            state.currentProject = projectId;
            loadProject(projectId);
            saveProjects();
            
            return projectId;
        }

        function loadProject(projectId) {
            const project = state.projects[projectId];
            if (!project) return;
            
            // Clear current canvas
            state.canvas.elements.forEach(el => el.element?.remove());
            state.canvas.elements = [];
            
            // Load project data
            state.currentProject = projectId;
            document.getElementById('projectName').textContent = project.name;
            
            // Restore canvas state
            if (project.canvas) {
                state.canvas.zoom = project.canvas.zoom || 1;
                state.canvas.panX = project.canvas.panX || 0;
                state.canvas.panY = project.canvas.panY || 0;
                updateCanvasTransform();
                updateZoomDisplay();
                
                // Restore elements (simplified)
                if (project.canvas.elements) {
                    // Would restore all elements here
                }
            }
        }

        function saveCurrentProject() {
            if (!state.currentProject) return;
            
            const project = state.projects[state.currentProject];
            if (!project) return;
            
            project.modified = new Date().toISOString();
            project.canvas = {
                elements: state.canvas.elements.map(el => ({
                    type: el.type,
                    id: el.id,
                    x: el.x,
                    y: el.y,
                    content: el.element.innerHTML || el.element.value || '',
                    style: el.element.getAttribute('style'),
                    attributes: getElementAttributes(el)
                })),
                zoom: state.canvas.zoom,
                panX: state.canvas.panX,
                panY: state.canvas.panY
            };
            
            saveProjects();
            showNotification('Project saved!');
        }

        function saveProjects() {
            try {
                localStorage.setItem('codecanvas_projects', JSON.stringify(state.projects));
                localStorage.setItem('codecanvas_current', state.currentProject);
            } catch(e) {
                console.error('Failed to save projects:', e);
            }
        }

        function loadProjects() {
            try {
                const projectsData = localStorage.getItem('codecanvas_projects');
                const currentId = localStorage.getItem('codecanvas_current');
                
                if (projectsData) {
                    state.projects = JSON.parse(projectsData);
                    if (currentId && state.projects[currentId]) {
                        loadProject(currentId);
                    }
                }
            } catch(e) {
                console.error('Failed to load projects:', e);
            }
        }

        function exportProject() {
            if (!state.currentProject) return;
            
            const project = state.projects[state.currentProject];
            if (!project) return;
            
            const dataStr = JSON.stringify(project, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${project.name.replace(/[^a-z0-9]/gi, '_')}.codecanvas`;
            link.click();
            
            URL.revokeObjectURL(url);
            showNotification('Project exported!');
        }

        function importProject() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.codecanvas,.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const project = JSON.parse(e.target.result);
                        project.id = 'project_' + Date.now();
                        state.projects[project.id] = project;
                        loadProject(project.id);
                        saveProjects();
                        showNotification('Project imported!');
                    } catch(err) {
                        alert('Failed to import project: Invalid file format');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function startAutosave() {
            setInterval(() => {
                if (state.currentProject) {
                    saveCurrentProject();
                }
            }, 30000); // Autosave every 30 seconds
        }

        // UI Functions
        function showNewProjectModal() {
            document.getElementById('newProjectModal').classList.add('active');
            document.getElementById('newProjectName').focus();
        }

        function showProjectModal() {
            const modal = document.getElementById('projectModal');
            const list = document.getElementById('projectList');
            
            list.innerHTML = '';
            
            Object.values(state.projects).forEach(project => {
                const item = document.createElement('div');
                item.className = 'project-item';
                item.dataset.id = project.id;
                item.innerHTML = `
                    <div>
                        <div>${project.name}</div>
                        <div class="project-date">Modified: ${new Date(project.modified).toLocaleString()}</div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    document.querySelectorAll('.project-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                });
                
                if (project.id === state.currentProject) {
                    item.classList.add('selected');
                }
                
                list.appendChild(item);
            });
            
            modal.classList.add('active');
        }

        function handleCreateProject() {
            const name = document.getElementById('newProjectName').value.trim();
            if (name) {
                createNewProject(name);
                closeModal();
                document.getElementById('newProjectName').value = '';
            }
        }

        function handleLoadProject() {
            const selected = document.querySelector('.project-item.selected');
            if (selected) {
                loadProject(selected.dataset.id);
                closeModal();
            }
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        function showQuickActions() {
            // Implement quick actions menu
            console.log('Quick actions menu');
        }

        function showNotification(message) {
            // Simple notification (in production, use a proper toast library)
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--bg-tertiary);
                color: var(--text-primary);
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: var(--shadow-lg);
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // Add fade out animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeOut {
                from { opacity: 1; transform: translateX(-50%) translateY(0); }
                to { opacity: 0; transform: translateX(-50%) translateY(10px); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
